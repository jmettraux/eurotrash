
<!-- _creatures.html -->

<script>
  var sizes = {
    //tiny: '2.5 × 2.5 ft',
    //small: '5 × 5 ft',
    //medium: '5 × 5 ft',
    //large: '10 × 10 ft',
    //huge: '15 × 15 ft',
    //gargantuan: '20 × 20 ft'
    //tiny: '(2.5ft)', small: '(5ft)', medium: '(5ft)', large: '(10ft)',
    //huge: '(15ft)', gargantuan: '(20ft)'
    tiny: 'tny .5×.5sq', small: 'sml 1×1sq', medium: 'med 1×1sq',
    large: 'lrg 2×2sq', huge: 'hge 3×3sq', gargantuan: 'gar 4×4sq'
  };

  onDocumentReady(function() {

    var gatherStats = function(e) {
      return elts(e, 'li').reduce(
        function(h, ee) {
          var s = ee.textContent.trim();
          var m = s.match(/^([^:]+):(.*)$/);
          h[m[1].toLowerCase()] = m[2].trim();
          return h; },
        {});
    };
    var mean = function() {
      return Math.ceil(
        Array.from(arguments).reduce(function(s, e) { return s + e; }) /
        arguments.length);
    };
    var invert = function(h) {
      return Object.keys(h).reduce(
        function(hh, k) { hh[k] = 21 - h[k]; return hh; },
        {});
    };
    var htos = function(h) {
      return Object.keys(h)
        .map(function(k) { return k.toUpperCase() + h[k]; })
        .join(' | ');
    };
    var htoe = function(h) {
      var e = c('div.htoe');
      var ks = Object.keys(h);
      ks.forEach(function(k, i) {
        var se = c('span');
        se.appendChild(c('code', k.toUpperCase()));
        se.appendChild(c('span', '' + h[k]));
        e.appendChild(se);
        if (i !== ks.length - 1) e.appendChild(c('span', ' | '));
      });
      return e;
    };
    var expandStats = function(h) {
      h.hd0 = h.hd;
      h.hd1 = parseInt(h.hd0, 10);
      h.hd2 = Math.floor(h.hd1 / 2);
      h.hp = Math.floor(h.hd1 * 4.5);
      if (h.hd0.slice(0, 1) === '(') {
        h.hd = ''; h.hd2 = 0; h.hp = parseInt(h.hd0.match(/(\d+)/)[1], 10);
      }
      else if (h.hd0.match(/\./)) {
        h.hd = '½'; h.hd2 = 0; h.hp = 2;
      }
      h.dcs0 = h.dcs;
      h.dcs = h.dcs.split(' ').reduce(
        function(hh, s) {
          hh[s.slice(0, 3)] = parseInt(s.slice(3), 10);
          return hh; },
        {});
      h.tcs = invert(h.dcs);
      h.tcs.bod = mean(h.tcs.str, h.tcs.con, h.tcs.dex);
      h.tcs.sou = mean(h.tcs.int, h.tcs.wis, h.tcs.cha);
      h.tcs.phy = mean(h.tcs.str, h.tcs.con);
      h.tcs.eva = mean(h.tcs.dex, h.tcs.int);
      h.tcs.men = mean(h.tcs.wis, h.tcs.cha);
      h.tcs.lea = mean(h.tcs.int, h.tcs.wis);
      h.tcs.imp = mean(h.tcs.dex, h.tcs.wis);
      h.tcs.all = mean(
        h.tcs.str, h.tcs.con, h.tcs.dex, h.tcs.int, h.tcs.wis, h.tcs.cha);
      h.dcs = invert(h.tcs);
      h.ini = `1d20 + ${h.dcs.imp}`;
      h.savh = { phy: h.tcs.phy, eva: h.tcs.eva, men: h.tcs.men };
      //h.save = `1d20 + ${h.hd2} ≥ ${htos(savh)}`;
      return h;
    };
    var setValue = function(e, k, ...vs) {
      var ve = elt(e, `.v.${k}`);
      ve.innerHTML = '';
      vs.forEach(function(v) {
        if (typeof v === 'string') { ve.textContent = v; }
        else if (v === undefined || v === null) {}
        else { ve.appendChild(v); }
      });
    };
    var makeGrid = function(h, tes) {
      var te = elt('#creature_template').content.cloneNode(true);
      var hde = c('div');
      hde.appendChild(c('span.hd', '' + h.hd));
      hde.appendChild(c('span.hp', `(hp${h.hp})`));
      setValue(te, 'hd', hde);
      setValue(te, 'ac', h.ac);
      setValue(te, 'ini', h.ini);
      setValue(te, 'att', h.attack);
      setValue(te, 'sav', `1d20 + ${h.hd2} ≥`, htoe(h.savh));
      setValue(te, 'mor', `2d6 ≤ ${h.morale}`);
      setValue(te, 'siz', sizes[h.size]);
      setValue(te, 'mov', h.move);
      var dch = {
        str: h.dcs.str, con: h.dcs.con, dex: h.dcs.dex,
        int: h.dcs.int, wis: h.dcs.wis, cha: h.dcs.cha };
      var dchh = {
        bod: h.dcs.bod, sou: h.dcs.sou,
        phy: h.dcs.phy, eva: h.dcs.eva, men: h.dcs.men, imp: h.dcs.imp };
      var dcse = c('div');
      dcse.appendChild(htoe(dch));
      dcse.appendChild(htoe(dchh));
      setValue(te, 'dcs', dcse);
      var txe = elt(te, '.t');
      txe.innerHTML = '';
      tes.forEach(function(te) { txe.appendChild(te); });
      return te;
    };

    elts('.creature').forEach(function(e) {
      var ule = elt(e, 'ul');
      var tes = elts(e, 'p');
      var h = expandStats(gatherStats(e));
      ule.remove();
      tes.forEach(function(e) { e.remove(); });
      e.appendChild(makeGrid(h, tes));
    });
  });

  onDocumentReady(function() {

    //
    // generate compass...

    var pages = elts('[data-aa-title="creatures"] .page');

    var firsts = pages.map(function(pe) {
      return elt(pe, '.creature h2').textContent; });

    pages.forEach(function(pe, i) {
      var k = firsts[i];
      var ule = elt(pe, 'ul.compass');
      firsts.forEach(function(f, j) {
        var lie;
        f = f.split(',')[0];
        if (i === j) {
          lie = c('li', ''); lie.appendChild(c('strong', f)); }
        else {
          lie = c('li', f); }
        ule.appendChild(lie);
      });
    });
  });

  onDocumentReady(function() {

    //
    // rewrite h2

    elts('.creature h2').forEach(function(h2e) {
      h2e.id = h2e.id.replaceAll(/,/g, '');
      var tt = h2e.textContent.trim().split(/ *, */);
      h2e.innerHTML = '';
      h2e.appendChild(c('span', tt.shift()));
      tt.forEach(function(t) { h2e.appendChild(c('span.post', ', ' + t)); });
    });
  });
</script>

<template id="creature_template">
  <div class="creature-grid">
    <div class="k s1 hd">HD</div><div class="v s1 hd">v</div>
    <div class="k s1 ac">AC</div><div class="v s1 ac">v</div>
    <div class="k s1 ini">Ini</div><div class="v s1 ini">v</div>
    <div class="k att">Atk</div><div class="v att">v</div>
    <div class="k sav">Sav</div><div class="v sav">v</div>
    <div class="k s1 mor">Mrl</div><div class="v s1 mor">v</div>
    <div class="k s1 siz">Siz</div><div class="v s1 siz">v</div>
    <div class="k mov">Mov</div><div class="v mov">v</div>
    <div class="k dcs">DCs</div><div class="v dcs">v</div>
    <div class="t">t</div>
  </div>
</template>

